clear;
clc;
a=[
    [0.005  1  0.12];
    [-0.006 -0.009 1];
    [-0.006 0.6  0.81496];
    [0.005 1  0.119];
    [0.006588 0.903288 -0.421632];
    [-0.103211  0.19544 -0.952454];
    [-0.00 0.000854 -0.98161];
    [-0.002196 -0.830575 -0.529479];
    [-0.00597 -1.00674 0.02574];
    [0.53875 -0.07564 0.85448];
    [-0.044 -0.00768 -0.98698];
    [0.85790  -0.0076589 0.526552];
    [1.00247 0.003660 0.03611];
    [0.935984 -0.003538 -0.33672];
    [0.657945 -0.001  -0.73895];
    [-0.46591  -0.04697 -0.86254];
    [-0.79019 -0.03025 -0.596458];
    [-0.009345794	0.00952381	1] ;
    [0.936 -0.003 -0.336];
    [-1	-0.00952381	0.044247788] ;
    [1	0.028571429	0.008849558] ;
    [-0.009345794	1	-0.115044248] ;
    [0.028037383	-1	0.008849558] ;
    [-0.775700935	-0.638095238	0.008849558] ;
    [-0.570093458	0.80952381	-0.026548673] ;
    [0.644859813	0.771428571	-0.061946903] ;
    [0.775700935	-0.619047619	-0.115044248] ;
    [0.981308411	0.00952381	-0.256637168];
];

% a = [
%         [-0.009345794	0.00952381	1];
%         [-1	-0.00952381	0.044247788];
%         [1	0.028571429	0.008849558];
%         [-0.009345794	1	-0.115044248];
%         [0.028037383	-1	0.008849558];
%         [-0.775700935	-0.638095238	0.008849558];
%         [-0.570093458	0.80952381	-0.026548673];
%         [0.644859813	0.771428571	-0.061946903];
%         [0.775700935	-0.619047619	-0.115044248 ];
%         [0.981308411	0.00952381	-0.256637168]
% ];

s = zeros(100,3);
[x,y,z] = ellipsoid(0,0,0,1000,1000,1300,9);
for i=1:10
    for j=1:10
        if mod(i+j,2) == 0
            s(i*10+j,1) = x(i,j);
            s(i*10+j,2) = y(i,j);
            s(i*10+j,3) = z(i,j);
        end
    end
end


s = unique(a,'rows');

[ofs,gain,rotM]=ellipsoid_fit(s,0)
%[gain,rotM]=refine_3D_fit(gain,rotM);
% 
%X=s(:,1);
%Y=s(:,2);
%Z=s(:,3);
% 
 X=a(:,1);
 Y=a(:,2);
 Z=a(:,3);
% 
 XC=X-ofs(1); 
 YC=Y-ofs(2); 
 ZC=Z-ofs(3);
% 
XYZC=[XC,YC,ZC]*rotM;
refr = 1;  
XC=XYZC(:,1)/gain(1)*refr;
YC=XYZC(:,2)/gain(2)*refr;
ZC=XYZC(:,3)/gain(3)*refr; 

Va = [XC, YC, ZC];
Vb = [X, Y, Z];

figure;
plot3(X,Y,Z,'x')
hold on
plot3(XC,YC,ZC,'ro')
hold on 

[SX,SY,SZ] = sphere;
SX = SX *1;
SY = SY *1;
SZ = SZ *1;
lightGrey = 0.9*[1 1 1];
surf(SX,SY,SZ,'FaceColor', 'none','EdgeColor',lightGrey)
axis equal
